name: ğŸš€ Deploy Streamlit App to EC2 (No ECR - With Rollback + Healthcheck)

on:
  push:
    branches:
      - main
      - master

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ§© Checkout repository
        uses: actions/checkout@v4

      - name: ğŸ”‘ Prepare SSH Key
        run: |
          echo "${{ secrets.EC2_SSH_KEY }}" > private_key.pem
          chmod 600 private_key.pem

      - name: ğŸŒ Test EC2 Connection
        run: |
          ssh -i private_key.pem -o StrictHostKeyChecking=no ubuntu@${{ secrets.EC2_PUBLIC_IP }} "echo 'âœ… Connected successfully!'"

      - name: ğŸ³ Build Docker image
        run: docker build -t opura-data-generation:latest .

      - name: ğŸ§± Save Docker image to tar file
        run: docker save -o app_image.tar opura-data-generation:latest

      - name: ğŸ“¤ Upload code to EC2 (repo instead of image)
        run: |
          scp -i private_key.pem -o StrictHostKeyChecking=no -r ./ ubuntu@${{ secrets.EC2_PUBLIC_IP }}:/home/ubuntu/opura-data-generation

      - name: ğŸš€ Deploy on EC2
        run: |
          ssh -i private_key.pem -o StrictHostKeyChecking=no ubuntu@${{ secrets.EC2_PUBLIC_IP }} << 'EOF'
            set -e
            cd /home/ubuntu/opura-data-generation

            echo "ğŸ§¹ Stopping old container..."
            docker stop opura-data-generation || true
            docker rm opura-data-generation || true

            echo "ğŸ³ Building new container..."
            docker build -t opura-data-generation:latest .

            echo "ğŸš€ Running container..."
            docker run -d \
              --name opura-data-generation \
              --restart unless-stopped \
              -p 8503:8503 \
              -e GOOGLE_APPLICATION_CREDENTIALS='${{ secrets.GCP_SERVICE_ACCOUNT_JSON }}' \
              opura-data-generation:latest

            echo "â³ Waiting for Streamlit app to start..."
            sleep 20

            echo "ğŸ” Running healthcheck..."
            if curl -fs http://localhost:8503 > /dev/null; then
              echo "âœ… Health check passed!"
            else
              echo "âŒ Health check failed! Rolling back..."
              docker stop opura-data-generation || true
              docker rm opura-data-generation || true
              docker run -d --name opura-data-generation -p 8503:8503 opura-data-generation:previous || true
              exit 1
            fi
          EOF

      - name: ğŸ§¹ Cleanup temporary files
        run: rm -f private_key.pem