name: ğŸš€ Deploy Streamlit App to EC2 (Direct Repo Sync, Port 8503, Rollback + Healthcheck)

on:
  push:
    branches: [ main ]
  workflow_dispatch:

env:
  APP_NAME: opura-data-generation
  CONTAINER_PORT: 8503
  HOST_PORT: 8503

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ§¾ Checkout repository
        uses: actions/checkout@v4

      - name: ğŸ”‘ Prepare SSH key
        run: |
          echo "${{ secrets.EC2_SSH_KEY }}" > private_key.pem
          chmod 600 private_key.pem

      - name: ğŸ§ª Test EC2 Connection
        run: |
          ssh -i private_key.pem -o StrictHostKeyChecking=no ubuntu@${{ secrets.EC2_HOST }} "echo âœ… Connected to $(hostname)"

      - name: ğŸ§¹ Clean previous deployment folder
        run: |
          ssh -i private_key.pem -o StrictHostKeyChecking=no ubuntu@${{ secrets.EC2_HOST }} \
          "rm -rf ~/opura-data-generation && mkdir -p ~/opura-data-generation"

      - name: ğŸšš Copy repository to EC2
        run: |
          rsync -avz -e "ssh -i private_key.pem -o StrictHostKeyChecking=no" ./ \
          ubuntu@${{ secrets.EC2_HOST }}:~/opura-data-generation

      - name: ğŸš€ Deploy container on EC2
        run: |
          ssh -i private_key.pem -o StrictHostKeyChecking=no ubuntu@${{ secrets.EC2_HOST }} << 'EOF'
            set -e
            cd ~/opura-data-generation

            echo "ğŸ›‘ Stopping old container (if running)..."
            docker stop opura-data-generation || true
            docker rm opura-data-generation || true

            echo "ğŸ§¹ Cleaning up unused images..."
            docker system prune -af || true

            echo "ğŸ³ Building new Docker image..."
            docker build -t opura-data-generation .

            echo "ğŸš€ Starting new container on port 8503..."
            docker run -d \
              --name opura-data-generation \
              --restart unless-stopped \
              -p 8503:8503 \
              -e GCP_SERVICE_ACCOUNT_JSON='${{ secrets.GCP_SERVICE_ACCOUNT_JSON }}' \
              opura-data-generation:latest

            echo "âŒ› Waiting 20 seconds for the app to start..."
            sleep 20

            echo "ğŸ” Running health check..."
            if curl -f http://localhost:8503 >/dev/null 2>&1; then
              echo "âœ… Health check passed! ğŸ‰"
            else
              echo "âŒ Health check failed â€” rolling back!"
              docker stop opura-data-generation || true
              exit 1
            fi
          EOF

      - name: ğŸ§¹ Cleanup temporary files
        if: always()
        run: rm -f private_key.pem