name: ğŸš€ Deploy Streamlit App to EC2 (Direct SSH - Fixed Path, Rollback, Healthcheck)

on:
  push:
    branches: [ main ]
  workflow_dispatch:

env:
  APP_NAME: opura-data-generation
  CONTAINER_PORT: 8501
  HOST_PORT: 8501

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ§¾ Checkout repository
        uses: actions/checkout@v4

      - name: ğŸ”‘ Prepare SSH key
        run: |
          echo "${{ secrets.EC2_SSH_KEY }}" > private_key.pem
          chmod 600 private_key.pem

      - name: ğŸ§ª Test EC2 Connection
        run: |
          echo "Testing SSH connectivity..."
          ssh -i private_key.pem -o StrictHostKeyChecking=no ubuntu@${{ secrets.EC2_HOST }} "echo âœ… Connected to $(hostname)"

      - name: ğŸ³ Build Docker image
        run: |
          docker build -t $APP_NAME .

      - name: ğŸ“¦ Save Docker image to tar file
        run: docker save $APP_NAME -o app_image.tar

      - name: ğŸšš Upload Docker image to EC2
        run: |
          scp -i private_key.pem -o StrictHostKeyChecking=no app_image.tar \
          ubuntu@${{ secrets.EC2_HOST }}:~/app_image.tar

      - name: ğŸš€ Deploy container on EC2
        run: |
          ssh -i private_key.pem -o StrictHostKeyChecking=no ubuntu@${{ secrets.EC2_HOST }} << 'EOF'
            set -e
            echo "ğŸ›‘ Stopping old container (if running)..."
            docker stop opura-data-generation || true
            docker rm opura-data-generation || true

            echo "ğŸ“¦ Loading Docker image..."
            docker load -i ~/app_image.tar
            rm -f ~/app_image.tar

            echo "ğŸš€ Starting new container..."
            docker run -d \
              --name opura-data-generation \
              --restart unless-stopped \
              -p 8501:8501 \
              -e GCP_SERVICE_ACCOUNT_JSON='${{ secrets.GCP_SERVICE_ACCOUNT_JSON }}' \
              opura-data-generation:latest

            echo "âŒ› Waiting 15 seconds for the app to start..."
            sleep 15

            echo "ğŸ” Performing health check..."
            if curl -f http://localhost:8501 >/dev/null 2>&1; then
              echo "âœ… Health check passed!"
            else
              echo "âŒ Health check failed â€” rolling back..."
              docker stop opura-data-generation || true
              exit 1
            fi

            echo "ğŸ‰ Deployment successful!"
          EOF

      - name: ğŸ§¹ Cleanup temporary files
        if: always()
        run: rm -f private_key.pem app_image.tar